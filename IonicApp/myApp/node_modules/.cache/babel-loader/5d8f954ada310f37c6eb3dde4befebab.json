{"ast":null,"code":"import { useContext, useEffect, useState } from 'react';\nimport { Plugins } from '@capacitor/core';\nimport { updateTrain } from \"../todo/TrainsAPI\";\nimport { AuthContext } from \"../auth\";\nconst {\n  BackgroundTask\n} = Plugins;\nconst {\n  Network\n} = Plugins;\nconst initialState = {\n  connected: false,\n  connectionType: 'unknown'\n};\n\nfunction buildTrainProps(train) {\n  return train;\n}\n\nexport const useNetwork = () => {\n  const [networkStatus, setNetworkStatus] = useState(initialState);\n  useEffect(() => {\n    const handler = Network.addListener('networkStatusChange', handleNetworkStatusChange);\n    Network.getStatus().then(handleNetworkStatusChange);\n    let canceled = false;\n    return () => {\n      canceled = true;\n      handler.remove();\n    };\n\n    function handleNetworkStatusChange(status) {\n      console.log('useNetwork - status change', status);\n\n      if (!canceled) {\n        if (status.connected) {\n          let taskId = BackgroundTask.beforeExit(async () => {\n            console.log('useBackgroundTask - executeTask started');\n            let items = [];\n            const {\n              Storage\n            } = Plugins;\n            const {\n              keys\n            } = await Storage.keys();\n\n            for (let i = 0; i < keys.length; i++) {\n              if (keys[i].startsWith(\"Bought:\")) {\n                const res = await Storage.get({\n                  key: keys[i]\n                });\n\n                if (res.value) {\n                  items.push(buildTrainProps(JSON.parse(res.value)));\n                }\n              }\n            }\n\n            const {\n              token,\n              logout,\n              isAuthenticated\n            } = useContext(AuthContext);\n\n            for (let i = 0; i < items.length; i++) {\n              const item = items[i];\n\n              try {\n                const savedItem = await (item._id ? updateTrain(token, item) : updateTrain(token, item));\n              } catch (error) {\n                console.log(\"error trying to update data for: \" + item);\n              }\n            }\n\n            console.log('useBackgroundTask - executeTask finished');\n            BackgroundTask.finish({\n              taskId\n            });\n          });\n        }\n\n        setNetworkStatus(status);\n      }\n    }\n  }, []);\n  return {\n    networkStatus\n  };\n};","map":{"version":3,"sources":["D:/PDM/IonicApp/myApp/src/network/useNetwork.tsx"],"names":["useContext","useEffect","useState","Plugins","updateTrain","AuthContext","BackgroundTask","Network","initialState","connected","connectionType","buildTrainProps","train","useNetwork","networkStatus","setNetworkStatus","handler","addListener","handleNetworkStatusChange","getStatus","then","canceled","remove","status","console","log","taskId","beforeExit","items","Storage","keys","i","length","startsWith","res","get","key","value","push","JSON","parse","token","logout","isAuthenticated","item","savedItem","_id","error","finish"],"mappings":"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","sourcesContent":["import {useContext, useEffect, useState} from 'react';\nimport { NetworkStatus, Plugins } from '@capacitor/core';\nimport {useBackgroundTask} from \"./useBackgroundTask\";\nimport {TrainProps} from \"../todo/TrainProps\";\nimport {updateTrain} from \"../todo/TrainsAPI\";\nimport {AuthContext} from \"../auth\";\n\nconst { BackgroundTask } = Plugins;\n\nconst { Network } = Plugins;\n\nconst initialState = {\n  connected: false,\n  connectionType: 'unknown',\n}\n\nfunction buildTrainProps(train: TrainProps){\n  return train;\n}\n\nexport const useNetwork = () => {\n  const [networkStatus, setNetworkStatus] = useState(initialState)\n  useEffect(() => {\n    const handler = Network.addListener('networkStatusChange', handleNetworkStatusChange);\n    Network.getStatus().then(handleNetworkStatusChange);\n    let canceled = false;\n    return () => {\n      canceled = true;\n      handler.remove();\n    }\n\n    function handleNetworkStatusChange(status: NetworkStatus) {\n      console.log('useNetwork - status change', status);\n      if (!canceled) {\n        if(status.connected){\n          let taskId = BackgroundTask.beforeExit(async () => {\n            console.log('useBackgroundTask - executeTask started');\n\n            let items = []\n            const {Storage} = Plugins;\n            const {keys} = await Storage.keys();\n            for (let i = 0; i < keys.length; i++) {\n              if (keys[i].startsWith(\"Bought:\")) {\n                const res = await Storage.get({key: keys[i]});\n                if (res.value) {\n                  items.push(buildTrainProps(JSON.parse(res.value)));\n                }\n              }\n            }\n\n            const {token, logout, isAuthenticated} = useContext(AuthContext);\n\n            for(let i=0; i<items.length; i++){\n              const item = items[i];\n              try {\n                const savedItem = await (item._id ? updateTrain(token, item) : updateTrain(token, item));\n              }catch (error){\n                console.log(\"error trying to update data for: \" + item);\n              }\n\n            }\n\n\n            console.log('useBackgroundTask - executeTask finished');\n            BackgroundTask.finish({ taskId });\n          });\n        }\n        setNetworkStatus(status);\n      }\n    }\n  }, [])\n  return { networkStatus };\n};\n"]},"metadata":{},"sourceType":"module"}